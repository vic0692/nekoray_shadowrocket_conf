name: Build rule-sets (srs + list)

on:
  push:
    paths:
      - "rules/source/*.txt"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
          
      - name: Download sing-box
        run: |
          VERSION=1.12.17
          wget https://github.com/SagerNet/sing-box/releases/download/v$VERSION/sing-box-$VERSION-linux-amd64.tar.gz
          tar -xzf sing-box-$VERSION-linux-amd64.tar.gz
          mv sing-box-$VERSION-linux-amd64/sing-box ./sing-box
          chmod +x ./sing-box
          ./sing-box version

      - name: Generate Shadowrocket .list
        run: |
          mkdir -p rules/shadowrocket
          for f in rules/source/*.txt; do
            name=$(basename "$f" .txt)
            out="rules/shadowrocket/${name}.list"
            echo "# ${name}" > "$out"
            sed 's/^/DOMAIN-SUFFIX,/' "$f" >> "$out"
          done

      - name: Generate sing-box JSON
        run: |
          mkdir -p rules/singbox
          for f in rules/source/*.txt; do
            name=$(basename "$f" .txt)
            json="rules/singbox/${name}.json"
            echo '{ "version": 1, "rules": [ { "domain_suffix": [' > "$json"
            sed 's/.*/"&",/' "$f" | sed '$ s/,$//' >> "$json"
            echo '] } ] }' >> "$json"
          done

      - name: Validate sing-box JSON
        run: |
          for f in rules/singbox/*.json; do
            jq empty "$f"
          done

      - name: Compile SRS
        run: |
          mkdir -p build
          for f in rules/singbox/*.json; do
            echo "Compiling $f"
            ./sing-box rule-set compile "$f"
            SRS="${f%.json}.srs"
      
            if [ ! -s "$SRS" ]; then
              echo "ERROR: $SRS is empty or missing"
              exit 1
            fi
      
            mv "$SRS" build/
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto build ${{ github.run_number }}
          body_path: RELEASE.md
          files: |
            build/*.srs
            rules/shadowrocket/*.list
            Nekoray/*.json
            Shadowrocket/*.conf

