name: Build rule-sets (srs + list)

on:
  push:
    paths:
      - "rules/source/*.txt"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sing-box
        run: |
          wget https://github.com/SagerNet/sing-box/releases/latest/download/sing-box-linux-amd64.tar.xz
          tar -xzf sing-box-linux-amd64.tar.gz
          chmod +x sing-box-*/sing-box
          sudo mv sing-box-*/sing-box /usr/local/bin/sing-box

      - name: Generate Shadowrocket .list
        run: |
          mkdir -p rules/shadowrocket
          for f in rules/source/*.txt; do
            name=$(basename "$f" .txt)
            out="rules/shadowrocket/${name}.list"
            echo "# ${name}" > "$out"
            sed 's/^/DOMAIN-SUFFIX,/' "$f" >> "$out"
          done

      - name: Generate sing-box JSON
        run: |
          mkdir -p rules/singbox
          for f in rules/source/*.txt; do
            name=$(basename "$f" .txt)
            json="rules/singbox/${name}.json"
            echo '{ "version": 1, "rules": [ { "domain_suffix": [' > "$json"
            sed 's/.*/"&",/' "$f" | sed '$ s/,$//' >> "$json"
            echo '] } ] }' >> "$json"
          done

      - name: Compile SRS
        run: |
          mkdir -p build
          for f in rules/singbox/*.json; do
            sing-box rule-set compile "$f"
            mv "${f%.json}.srs" build/
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.run_number }}
          name: Auto build ${{ github.run_number }}
          files: build/*.srs
